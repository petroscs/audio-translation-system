version: '3.8'

services:
  backend:
    build:
      context: ..
      dockerfile: deployment/docker/backend/Dockerfile
    container_name: audio-translation-backend
    ports:
      - "5000:5000"
      - "5001:5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000;https://+:5001
      - ConnectionStrings__DefaultConnection=Data Source=/data/audio_translation.db
      - Mediasoup__ApiUrl=http://mediasoup:4000
      - JWT__Secret=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT__Issuer=${JWT_ISSUER:-audio-translation-system}
      - JWT__Audience=${JWT_AUDIENCE:-audio-translation-clients}
    volumes:
      - db_data:/data
      - ./logs/backend:/app/logs
    depends_on:
      - mediasoup
    networks:
      - audio-translation-network
    restart: unless-stopped

  mediasoup:
    build:
      context: ..
      dockerfile: deployment/docker/mediasoup/Dockerfile
    container_name: audio-translation-mediasoup
    ports:
      - "4000:4000"
      - "10000-10100:10000-10100/udp"
    environment:
      - MEDIASOUP_ANNOUNCED_IP=${SERVER_IP:-127.0.0.1}
      - MEDIASOUP_MIN_PORT=10000
      - MEDIASOUP_MAX_PORT=10100
      - NODE_ENV=production
    networks:
      - audio-translation-network
    restart: unless-stopped
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined

  stt-worker:
    build:
      context: ..
      dockerfile: deployment/docker/stt-worker/Dockerfile
    container_name: audio-translation-stt-worker
    ports:
      - "5002:5002"
    environment:
      - MEDIASOUP_API_URL=http://mediasoup:4000
      - BACKEND_API_URL=http://backend:5000
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - NODE_ENV=production
    networks:
      - audio-translation-network
    depends_on:
      - mediasoup
      - backend
    restart: unless-stopped

  recording-worker:
    build:
      context: ..
      dockerfile: deployment/docker/recording-worker/Dockerfile
    container_name: audio-translation-recording-worker
    ports:
      - "5003:5003"
    environment:
      - MEDIASOUP_API_URL=http://mediasoup:4000
      - BACKEND_API_URL=http://backend:5000
      - RECORDINGS_PATH=/recordings
      - NODE_ENV=production
    volumes:
      - recordings:/recordings
    networks:
      - audio-translation-network
    depends_on:
      - mediasoup
      - backend
    restart: unless-stopped

  admin-dashboard:
    build:
      context: ..
      dockerfile: deployment/docker/admin-dashboard/Dockerfile
    container_name: audio-translation-admin-dashboard
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=${API_URL:-http://localhost:5000}
    networks:
      - audio-translation-network
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  db_data:
    driver: local
  recordings:
    driver: local

networks:
  audio-translation-network:
    driver: bridge
