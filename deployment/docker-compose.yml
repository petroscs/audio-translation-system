services:
  backend:
    build:
      context: ..
      dockerfile: deployment/docker/backend/Dockerfile
    container_name: audio-translation-backend
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      # HTTP only - no dev cert in Docker; use reverse proxy for TLS in production
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Data Source=/data/audio_translation.db
      - Mediasoup__BaseUrl=http://mediasoup:4000
      - SttWorker__BaseUrl=http://stt-worker:5002
      - SttWorker__ApiKey=${STT_WORKER_API_KEY:-stt-worker-secret}
      - RecordingWorker__BaseUrl=http://recording-worker:5003
      - RecordingWorker__ApiKey=${RECORDING_WORKER_API_KEY:-recording-worker-secret}
      - Recordings__Path=/recordings
      - JWT__Secret=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT__Issuer=${JWT_ISSUER:-audio-translation-system}
      - JWT__Audience=${JWT_AUDIENCE:-audio-translation-clients}
    volumes:
      - db_data:/data
      - recordings:/recordings
      - ./logs/backend:/app/logs
    depends_on:
      - mediasoup
    networks:
      - audio-translation-network
    restart: unless-stopped

  mediasoup:
    build:
      context: ..
      dockerfile: deployment/docker/mediasoup/Dockerfile
    container_name: audio-translation-mediasoup
    ports:
      - "4000:4000"
      - "10000-10100:10000-10100/udp"
    environment:
      - MEDIASOUP_ANNOUNCED_IP=${SERVER_IP:-127.0.0.1}
      - MEDIASOUP_MIN_PORT=10000
      - MEDIASOUP_MAX_PORT=10100
      - NODE_ENV=production
    networks:
      - audio-translation-network
    restart: unless-stopped
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined

  stt-worker:
    build:
      context: ..
      dockerfile: deployment/docker/stt-worker/Dockerfile
    container_name: audio-translation-stt-worker
    ports:
      - "5002:5002"
    environment:
      - MEDIASOUP_API_URL=http://mediasoup:4000
      - BACKEND_API_URL=http://backend:5000
      - STT_WORKER_HOST=stt-worker
      - STT_WORKER_API_KEY=${STT_WORKER_API_KEY:-stt-worker-secret}
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - NODE_ENV=production
    networks:
      - audio-translation-network
    depends_on:
      - mediasoup
      - backend
    restart: unless-stopped

  recording-worker:
    build:
      context: ..
      dockerfile: deployment/docker/recording-worker/Dockerfile
    container_name: audio-translation-recording-worker
    ports:
      - "5003:5003"
    environment:
      - MEDIASOUP_API_URL=http://mediasoup:4000
      - BACKEND_API_URL=http://backend:5000
      - RECORDINGS_PATH=/recordings
      - RECORDING_WORKER_HOST=recording-worker
      - RECORDING_WORKER_API_KEY=${RECORDING_WORKER_API_KEY:-recording-worker-secret}
      - NODE_ENV=production
    volumes:
      - recordings:/recordings
    networks:
      - audio-translation-network
    depends_on:
      - mediasoup
      - backend
    restart: unless-stopped

  admin-dashboard:
    build:
      context: ..
      dockerfile: deployment/docker/admin-dashboard/Dockerfile
      args:
        VITE_API_URL: ${API_URL:-http://localhost:5000}
        VITE_LISTENER_BASE_URL: ${LISTENER_URL:-http://localhost:3001}
    container_name: audio-translation-admin-dashboard
    ports:
      - "3000:3000"
    networks:
      - audio-translation-network
    depends_on:
      - backend
    restart: unless-stopped

  web-listener:
    build:
      context: ..
      dockerfile: deployment/docker/web-listener/Dockerfile
      args:
        VITE_API_URL: ${API_URL:-http://localhost:5000}
    container_name: audio-translation-web-listener
    ports:
      - "3001:3001"
    networks:
      - audio-translation-network
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  db_data:
    driver: local
  recordings:
    driver: local

networks:
  audio-translation-network:
    driver: bridge
